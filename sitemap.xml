<?php
header('Content-Type: application/xml; charset=utf-8');
require_once 'config/database.php';

echo '<?xml version="1.0" encoding="UTF-8"?>' . "\n";
?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">
  
  <!-- Homepage -->
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
  </url>
  
  <!-- Categorias principais -->
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/comer-beber</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/compras</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/saude-bem-estar</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/viagem-turismo</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/tecnologia</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/educacao</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/categoria/lazer</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <!-- Páginas estáticas -->
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/entrar</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>monthly</changefreq>
    <priority>0.6</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/seja-parceiro</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>monthly</changefreq>
    <priority>0.7</priority>
  </url>
  
  <url>
    <loc>https://<?php echo $_SERVER['HTTP_HOST']; ?>/public/categorias.php</loc>
    <lastmod><?php echo date('c'); ?></lastmod>
    <changefreq>daily</changefreq>
    <priority>0.9</priority>
  </url>
  
  <?php
  // Adicionar empresas dinamicamente
  try {
      $stmt = $conn->prepare("SELECT id, nome, categoria, updated_at FROM empresas WHERE status = 'aprovada' ORDER BY nome ASC");
      $stmt->execute();
      $empresas = $stmt->fetchAll();
      
      foreach ($empresas as $empresa) {
          $empresa_slug = strtolower(str_replace([' ', '&'], ['-', 'e'], $empresa['nome']));
          $empresa_slug = preg_replace('/[^a-z0-9\-]/', '', $empresa_slug);
          $lastmod = $empresa['updated_at'] ? date('c', strtotime($empresa['updated_at'])) : date('c');
          
          echo "  <url>\n";
          echo "    <loc>https://" . $_SERVER['HTTP_HOST'] . "/empresa/" . $empresa_slug . "-" . $empresa['id'] . "</loc>\n";
          echo "    <lastmod>" . $lastmod . "</lastmod>\n";
          echo "    <changefreq>weekly</changefreq>\n";
          echo "    <priority>0.7</priority>\n";
          echo "  </url>\n";
      }
  } catch (Exception $e) {
      // Em caso de erro na conexão, continuar sem as empresas
  }
  ?>
  
</urlset>